services:
  mysql:
    image: mysql:8.0
    platform: linux/amd64
    container_name: mini-env-mysql
    restart: unless-stopped
    ports:
      - "3306:3306"
    environment:
      MYSQL_ROOT_PASSWORD: root123
      TZ: Asia/Shanghai
    volumes:
      - ./mysql/data:/var/lib/mysql
      - ./mysql/config:/etc/mysql/conf.d
      - ./mysql/logs:/var/log/mysql
      - ./mysql/init:/docker-entrypoint-initdb.d
    command: 
      - --default-authentication-plugin=mysql_native_password
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
    networks:
      - mini-env-network
    deploy:
      resources:
        limits:
          memory: 512m
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-proot123"]
      interval: 10s
      timeout: 5s
      retries: 5

  mongodb:
    image: mongodb/mongodb-community-server:7.0-ubuntu2204
    platform: linux/arm64/v8
    container_name: mini-env-mongodb
    restart: unless-stopped
    ports:
      - "27017:27017"
    environment:
      TZ: Asia/Shanghai
    volumes:
      - ./mongodb/data:/data/db
      - ./mongodb/logs:/var/log/mongodb
      - ./mongodb/config:/etc/mongo
    networks:
      - mini-env-network
    deploy:
      resources:
        limits:
          memory: 512m

  rocketmq-namesrv:
    image: apache/rocketmq:5.3.2
    platform: linux/amd64
    container_name: mini-env-rocketmq-namesrv
    restart: unless-stopped
    ports:
      - "9876:9876"   # NameServer
    environment:
      TZ: Asia/Shanghai
      # 仅限制堆大小，避免与镜像内默认 GC 选项冲突
      JAVA_OPT_EXT: "-server -Xms256m -Xmx256m -Xmn128m -XX:+ExitOnOutOfMemoryError"
    command: >
      sh -c "cd /home/rocketmq/rocketmq-5.3.2/bin &&
      ./mqnamesrv"
    volumes:
      - ./rocketmq/logs:/home/rocketmq/logs
    networks:
      - mini-env-network
    deploy:
      resources:
        limits:
          memory: 512m

  rocketmq-broker:
    image: apache/rocketmq:5.3.2
    platform: linux/amd64
    container_name: mini-env-rocketmq-broker
    restart: unless-stopped
    ports:
      - "10911:10911" # Broker
    environment:
      TZ: Asia/Shanghai
      NAMESRV_ADDR: rocketmq-namesrv:9876
      # 同样只控制堆大小，GC 策略使用镜像默认配置
      JAVA_OPT_EXT: "-server -Xms1g -Xmx1g -Xmn256m -XX:+ExitOnOutOfMemoryError"
    command: >
      sh -c "cd /home/rocketmq/rocketmq-5.3.2/bin &&
      ./mqbroker -n rocketmq-namesrv:9876 autoCreateTopicEnable=true"
    volumes:
      - ./rocketmq/store:/home/rocketmq/store
      - ./rocketmq/logs:/home/rocketmq/logs
      - ./rocketmq/conf:/home/rocketmq/conf
    depends_on:
      - rocketmq-namesrv
    networks:
      - mini-env-network
    deploy:
      resources:
        limits:
          memory: 2g

  rocketmq-dashboard:
    image: apacherocketmq/rocketmq-dashboard:latest
    platform: linux/amd64
    container_name: mini-env-rocketmq-dashboard
    restart: unless-stopped
    ports:
      - "8081:8080"
    environment:
      TZ: Asia/Shanghai
      ROCKETMQ_CONFIG_NAMESRV_ADDR: rocketmq-namesrv:9876
    depends_on:
      - rocketmq-namesrv
      - rocketmq-broker
    networks:
      - mini-env-network
    deploy:
      resources:
        limits:
          memory: 256m

  rocketmq-exporter:
    image: apache/rocketmq-exporter:latest
    platform: linux/amd64
    container_name: mini-env-rocketmq-exporter
    restart: unless-stopped
    ports:
      - "5557:5557"
    environment:
      TZ: Asia/Shanghai
      ROCKETMQ_CONFIG_NAMESRV_ADDR: rocketmq-namesrv:9876
    depends_on:
      - rocketmq-namesrv
      - rocketmq-broker
    networks:
      - mini-env-network
    deploy:
      resources:
        limits:
          memory: 256m

  mysql-exporter:
    image: prom/mysqld-exporter:v0.16.0
    platform: linux/amd64
    container_name: mini-env-mysql-exporter
    restart: unless-stopped
    # 使用 .my.cnf 配置连接信息，避免启动时反复报 no user specified
    volumes:
      - ./mysql/config/mysqld_exporter.cnf:/etc/mysql/.my.cnf:ro
    command:
      - "--config.my-cnf=/etc/mysql/.my.cnf"
    ports:
      - "9104:9104"
    networks:
      - mini-env-network
    depends_on:
      - mysql

  redis-exporter:
    image: oliver006/redis_exporter:v1.64.0
    platform: linux/amd64
    container_name: mini-env-redis-exporter
    restart: unless-stopped
    environment:
      REDIS_ADDR: "redis://mini-env-redis:6379"
    ports:
      - "9121:9121"
    networks:
      - mini-env-network
    depends_on:
      - redis

  mongodb-exporter:
    image: percona/mongodb_exporter:0.40.0
    platform: linux/amd64
    container_name: mini-env-mongodb-exporter
    restart: unless-stopped
    environment:
      MONGODB_URI: "mongodb://mini-env-mongodb:27017"
    command:
      - --collect-all
    ports:
      - "9216:9216"
    networks:
      - mini-env-network
    depends_on:
      - mongodb

  prometheus:
    image: prom/prometheus:v2.54.0
    platform: linux/arm64/v8
    container_name: mini-env-prometheus
    restart: unless-stopped
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus/config/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./prometheus/data:/prometheus
    networks:
      - mini-env-network
    deploy:
      resources:
        limits:
          memory: 512m

  grafana:
    image: grafana/grafana:10.4.3
    platform: linux/arm64
    container_name: mini-env-grafana
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: admin
      TZ: Asia/Shanghai
    volumes:
      - ./grafana/data:/var/lib/grafana
      - ./grafana/logs:/var/log/grafana
    networks:
      - mini-env-network
    deploy:
      resources:
        limits:
          memory: 512m

  redis:
    image: redis:7-alpine
    platform: linux/arm64/v8
    container_name: mini-env-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - ./redis/data:/data
      - ./redis/config:/usr/local/etc/redis
      - ./redis/logs:/var/log/redis
    command: redis-server /usr/local/etc/redis/redis.conf
    networks:
      - mini-env-network
    deploy:
      resources:
        limits:
          memory: 256m
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  xxl-job:
    build:
      context: ./xxl-job
      dockerfile: Dockerfile
    image: mini-env-xxl-job:2.3.1
    platform: linux/amd64
    container_name: mini-env-xxl-job
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      JAVA_TOOL_OPTIONS: "-Xms256m -Xmx256m -XX:+UseG1GC -XX:+ExitOnOutOfMemoryError"
    volumes:
      - ./xxl-job/logs:/app/logs
      - ./xxl-job/config:/app/config
    networks:
      - mini-env-network
    depends_on:
      mysql:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 512m

networks:
  mini-env-network:
    driver: bridge

